# Lab3 PSO materials

</br>
</br>

Index

1. handout go through
1. in memory file system
1. interrupt and function arguments
1. asm function, inline asm 
1. caller callee convention
1. return values
1. elf system



</br>
</br>
</br>
</br>

------------------------------------------
</br>

</br>
</br>

### 0. Project setup
1. Accept the project [CLICK Github Classroom Lab3 Link]();
2. [Read the Lab3 handout](https://www.cs.purdue.edu/homes/pfonseca/teaching/cs503/21spring/labs/lab3.html) multiple times before start.


</br>
</br>
</br>
</br>
</br>

</br>
</br>

------------------------------------------
</br>



### 1. Handout

</br>

- Basic in-memory file system (30pt)

* `syscall fileregister(char *path, char *file, int file_size)`
* `char* fileopen(char *path, int *file_size_out)`
* `syscall fileclose(char *path)`
* `syscall filelist(char *buf_list_out, int buf_list_max)`
* `syscall fileunregister(char *path)`

</br>

- Implement a system call interface based on software interrupts (30 pts)

  Instead of directly call system function, we use a uniform interface function trigger a software interrupt. And let the interrupt service function do the actual system function based on the input arguments. 

</br>


- Create a new system call that dynamically loads a program (60 pts)
 Parse the elf files, set memory and fill in the *load_data* with details.

 
</br>
</br>
</br>
</br>

</br>
</br>

------------------------------------------
</br>
</br>
</br>


### 2. In memory file system

* memory.h
* getmem.c
* freemem.c

linklist, semaphore

</br>

* How does XINU implment memory system's link list?

* How to implement a link list for general purpose?

```plain-text
struct Node {                                  |    struct Node {
    int val;                                   |        int val;
    struct Node* nxt;                          |        struct Node* nxt;
};                                             |    }
                                               |    
struct Node* n1 = new struct Node();           |    struct Node* n1 = getmem( sizeof(struct Node) );
struct Node* n2 = new struct Node();           |    struct Node* n2 = getmem( sizeof(struct Node) );
                                               |    
n1->nxt = n2;                                  |    n1->nxt = n2;
```

</br>
</br>
</br>

------------------------------------------
</br>
</br>
</br>

### 3. interrupt system and function argument

* What is software interrupt. And difference with the function call?

Software interrupt generated by the software `int` instruction. i.e. the famous x86 system system call reserved `0x80` interrupt.

When software interrupt was raise, the cpu would push the current contents of the EFLAGS, CS, and EIP registers on the stack.
</br>
</br>


* Some useful files.
* evec.c
* intra.S

</br>
</br>
</br>
</br>

Function call case:
```
int fun(int a1, int a2){
  int y=a1+a2;
  return y; 
}

int main(){
   int x=0;
   x++;
   fun1(3,5);
   x=5;   //<- this is the return address pushed to the stack
   return;
}

```

```asm

main: 
   pushl $5
   pushl $3
   call fun1. // push the eip, jmp to fun1
   ret    // pop the eip from the stack top

```

```
xxx
xxx
0x0014 :
0x0010 :   x
0x000c :   5
0x0008 :   3
0x0004 :  0xabcdef
0x0000 :
```
</br>
</br>
</br>
</br>

Interrupt case:
```
int fun(int a1, int a2){
  int y=a1+a2;
  return y;
}

int main(){
   int x=0;
   x++;
   // an interrupt happens here. i.e. asm("int $0x80");
   x=5;
   return;
}

```


```asm

main: 
   pushl $5
   pushl $3
   int %0x80 // push flag, push the eip, jmp to fun1
   ret    // pop the eip from the stack top

```

```
xxx
xxx
0x0014 :
0x0010 :   x
0x000c :   5
0x0008 :   3
0x0004 :  Flag-xxxxxx
0x0000 :  0xabcdef

```

```




</br>
</br>
</br>



------------------------------------------
</br>
</br>
</br>


### 4. asm function, inline asm 

some examples.
ctxsw.S
syscall_interface.c

</br>
</br>
</br>




------------------------------------------
</br>
</br>
</br>

### 5. caller callee convention


</br>
</br>
</br>




------------------------------------------
</br>
</br>
</br>

### 6. return values


</br>
</br>
</br>




------------------------------------------
</br>
</br>
</br>

### 7. elf system


</br>
</br>
</br>




------------------------------------------
</br>
</br>
</br>



